


{% extends "base.html" %} 


{% block page-wrapper %}

            <div class="container-fluid">

                <!-- Page Heading -->
                <div class="row">
                    <div class="col-lg-12">
                        <h4 class="page-header">
                            主机组管理
                        </h4>
                    </div>
                </div>     
                <div class="row">
                    <div class="col-lg-12">
                    
                    <ul>
                     <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addgroupModal">新增主机组</button>
                     <button type="button" class="btn btn-primary" id="rmgroup" data-toggle="modal" data-target="#removegroupModal">删除主机组</button>
                     <button type="button" class="btn btn-primary" id="showmember" data-toggle="modal" data-target="#showmembersModal">查看组成员</button>
                     <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#">组成员管理</button>
                     
                     <button type="button" class="btn btn-primary hide" id="smanage" data-toggle="modal" data-target="#showactionModal">
                      Launch demo modal
                    </button>
                    </ul>
                    
                    </div>
                </div>
                
                <!-- /.row -->
                <div class="row">
                <!-- modal add group -->
                <div class="modal fade" id="addgroupModal" tabindex="-1" role="dialog" aria-labelledby="addgroupModalLabel">
                  <div class="modal-dialog modal-sm" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="addgroupModalLabel">Modal title</h4>
                      </div>
                      <div class="modal-body">
                        <p class="bg-danger groupform" ></p>
                        <div class="container-fluid">
                        <form id= "addgroupform" class="form-horizontal">
                            <div class="form-group">
                                <label for="groupname">主机组名称:</label>
                                <input type="text" class="form-control" id="groupname" placeholder="xmserver">
                            </div>
                        </form>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="savegroup" >Save changes</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- modal add group-->
                
                <!-- modal remove group-->
                <div class="modal fade" id="removegroupModal" tabindex="-1" role="dialog" aria-labelledby="removegroupModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h3 class="modal-title" id="removegroupModalLabel">删除主机组</h3>
                      </div>
                      <div class="modal-body">
                         <h5>你将删除主机组:<kbd ></kbd></h5>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="commitremove">Commit</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- modal remove group-->
                
                <!-- modal show group members -->
                <div class="modal fade" id="showmembersModal" tabindex="-1" role="dialog" aria-labelledby="showmembersModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="showmembersModalLabel">主机组成员:</h4>
                      </div>
                      <div class="modal-body">
                        <table id="memberlist" class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>主机名称</th>
                                    <th>主机IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                        </table>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- modal show group members -->
                
                <!-- modal show action host-->
                <div class="modal fade" id="showactionModal" tabindex="-1" role="dialog" aria-labelledby="showactionModalLabel">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="showactionModalLabel">Service管理</h4>
                      </div>
                      <div class="modal-body">
                       <input id="clickprojectid" value="0" class="hide" >
                       
                       <table class="table  table-hover table-striped">
                           <thead>
                            <tr>
                                <th>ID</th>
                                <th>Action Name</th>
                                <th>Comment</th>
                                <th>Operation</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                       </table>
                       
                       <p class="bg-danger runaction hidden"><button type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button></p>
                       <div class="hidden" id="todisplay">
                       <button type="button" class="close" ><span aria-hidden="true">&times;</span></button>
                       <textarea class="form-control hidden" id="actionhistory" rows="15" placeholder="请将测试后的playbook内容粘贴到此处。">
                       </textarea>
                       </div>
                      </div>
                      
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- modal show action host-->
                
                <!-- modal manage host group -->
                <div class="modal fade" id="hostgroupModal" tabindex="-1" role="dialog" aria-labelledby="hostgroupModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h3 class="modal-title" id="hostgroupModalLabel">主机组管理</h3>
                      </div>
                      <div class="modal-body">
                         <h5>你将删除主机:<kbd ></kbd></h5>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="commitremove">Commit</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- modal manage host group-->
                
                <p class="bg-danger addgps hidden">主机组添加成功！<button type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button></p>
                <p class="bg-danger addgpf hidden" >主机组添加失败!<button type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button></p>
                <p class="bg-danger rmgps hidden" >主机组删除成功!<button type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button></p>
                <p class="bg-danger rmgpf hidden" >主机组删除失败!<button type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button></p>
                <div class="table-responsive">
                <table id='grouplist' class="table table-bordered table-hover table-striped">
                    <thead>
                        <tr>
                            <th>全选,反选</th>
                            <th>主机组ID</th>
                            <th>主机组名称</th>
                            <th>动作</th>
                           
                        </tr>
                    </thead>
                    <tbody>
                        
                    </tbody>
                </table>
                </div>
                <!-- Flot Charts -->

                <!-- row page -->
               <nav>
                  <ul class="pager">
                    <li><button  type="button" class="btn btn-info btn-sm" id="upPage" ><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> Up</button></li>
                    <strong id="pageNum">1</strong>
                    <li><button type="button" class="btn btn-info btn-sm" id="downPage">Down <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></button></li>
                  </ul>
              </nav>
                <!-- row page -->    
            </div>
           
            
            <!-- /.container-fluid -->
           
{% end %}
    
{% block script-extend %}
    
    <script>
    //*****************************  Show group table ************************//
    // checkbox change css when check or uncheck  and push id to checklist[]
    var checklist = [];
   function checkBindFunction(){
        $('table tbody :checkbox').click(function(){ 
            if($(this).prop('checked')){
                 checklist.push($(this).parent().siblings().first().text());
                $(this).parent().parent().addClass('success')
            }else{
                 checklist.pop(checklist.indexOf($(this).parent().siblings().first().text()));
                $(this).parent().parent().removeClass('success')
            };
        })
        
        $('button.smanage').click(function(){
            var clickprojectid = $(this).parent().siblings().first().next().text();
            $("#smanage").click();
            $("#clickprojectid").val(clickprojectid);
            showGroupAction();
        })
   }
   
   function bindTodoAction(){
        
        $("#showactionModal tbody tr button").click(function(){
        let actionid = $(this).parent().siblings().first().text();
        let action = $(this).attr('action');
        //let servername =  $(this).parent().siblings().first().text() ;
        let groupid = $("#clickprojectid").val();
        //console.log(action+':'+actionid);
       
        $("#todisplay .close").click(function(){
            console.log('ttttt');
            $("#actionhistory").val('');
            $("#todisplay").addClass("hidden");
        })
        
        var $btn = $(this).button('loading')
        $(this).siblings().attr("disabled","disabled");
        let that = $(this);
        
        if ( action == "run"){
            var url = "actionmanager/run/"+actionid;
            function runAction(msg){
                $(".runaction").text(msg);
                $(".runaction").removeClass('hidden');
                setTimeout(function(){
                $(".runaction").addClass('hidden');
                },8000)
             };
            //
            $.ajax(url,{dataType:'json',type:'POST',data:{action:action,'objecttype':'Hostgroup','objectid':groupid}}
            ).done(function(data){
                console.log(data);
                //console.log(data['pid']);
                $btn.button('reset');
                $btn.siblings().removeAttr('disabled');
                runAction(data['result']);
            }).fail(function(){
                console.log('fail')
                $btn.button('reset');
                $btn.siblings().removeAttr('disabled');
                runAction(data['result']);
            })
            
        }else if (action == "show"){
            var url = "actionmanager/history/"+actionid;
            $.ajax(url,{dataType:'json',type:'GET'}
            ).done(function(data){
                console.log(data);
                $btn.button('reset');
                $btn.siblings().removeAttr('disabled');
                $("#todisplay").removeClass("hidden");
                $("#actionhistory").removeClass("hidden");
                $("#actionhistory").val('');
                var comment = '';
                for (li in  data['data']){
                    console.log(data['data'][li]);
                    comment = comment+data['data'][li];
                }
                $("#actionhistory").val(comment);
                
            }).fail(function(){
                console.log('fail')
                $btn.button('reset');
                $btn.siblings().removeAttr('disabled');
                runAction(data['result']);
            })
            
        }
        
        })
        
    }
    
   function showGroupAction(){
   
        // url = http://172.17.92.167:8080/actionmanager/owner/hostgroup/1
        var url = 'actionmanager/owner/hostgroup/'+$('#clickprojectid').val();
        
        $.ajax(url,{dataType:'json'}).done(function(data){
            console.log("test");
            console.log(data);
            var Actiondata ={};
            for (key in data['data']){
                console.log(data['data'][key]);
                Actiondata[key]=[];
                Actiondata[key].push(data['data'][key]['id']);
                Actiondata[key].push(data['data'][key]['name']);
                Actiondata[key].push(data['data'][key]['author']);
            }
            console.log("asdfad");
            var tb = $('#showactionModal table  tbody');
            tb.children().remove();
            let endtdhtml = '<button type="button" class="btn btn-primary btn-sm action" action="run">执行</button>&nbsp&nbsp<button type="button" class="btn btn-primary btn-sm action" action="show">查看</button>'
            showDataTable(tb,Actiondata,undefined,endtdhtml,bindTodoAction);
        }).fail(function(){
            console.log("fail");
        })

   
   }
    
    // Get group list from server api and  call showDataTable()  to display table body.
    function  getTableData(){
        var url='/group/';
        page=$("#pageNum").text();
        var jqxhr = $.ajax(url,{ dataType:'json',data:{'page':page}}
        
        ).done(function(data){
            let stdhtml = '<input type="checkbox">';
            let tb = $('#grouplist tbody');
            let endtdhtml = '<button type="button" class="btn btn-link smanage"><span class="glyphicon glyphicon-th" aria-hidden="true"></span></button>';
            showDataTable(tb,data,stdhtml,endtdhtml,checkBindFunction);
            }
        ).fail(function(xhr,status){
            console.log(status)}
        )
        //console.log("tobj:"+tobj);
        return 1;
    }
    getTableData();
    
    // Clear add group form value
    function clearFormValue(){
        $("#addgroupform :input").each(function(){
            this.value = '';     
        });
     }
     
    //Add group: post data to server api.
    function postData(data={}){
        var url='group/';
        function addgpf(){
               $(".addgpf").removeClass('hidden');
               setTimeout(function(){
               $(".addgpf").addClass('hidden');
               },5000)
         };
         function addgps(){
            $(".addgps").removeClass('hidden');
               setTimeout(function(){
               $(".addgps").addClass('hidden');
               },5000)
         }
       
        var jqxhr1 = $.ajax(url,{
                type:'POST',
                dataType:'json',
                data:data,
                }
        ).done(
            function(data){
              if(data['status'] == 'success'){
                  console.log(data['status']);
                  clearFormValue();
                  getTableData();
                  addgps();
              }else{
                   addgpf();
              } 
            }
        ).fail(function(){
            addgpf();}
        )
     }
     
     // Events:click  with  button that to add group.
     $("#savegroup").on('click',function(){
        var savedata = {};
        namere=/^[a-zA-Z]+\w+$/;
        
        $("#addgroupform :input").each(function(){
            //console.log(this.id,this.value);
            savedata[this.id]=this.value;
            
        });
        
        if ( ! namere.test(savedata['groupname'] )){
               $(".groupform").text("主机组名称只能由：字母，数组，-,符号构成！不能以数字开头！");
               $(".groupform").removeClass('hidden');
               setTimeout(function(){
               $(".groupform").addClass('hidden');
               },2000);
        } else{
            var $btn = $(this).button('loading');
            console.log(savedata);
            postData(savedata);
            $btn.button('reset');
            $('#addgroupModal button.close').click();
        }
        
     });
    
    //======Remove group=======
    //Get checked checkbox value ,return a arrray
    function getCheckArray(){
        var selectAll = $('table tbody :checkbox:checked');
        var arr = [];
        selectAll.each(function(){ arr.push( $(this).parent().next().next().text())    }) ;
        return arr;
    }
     
    // Remove group 
    $('#rmgroup').on('click',function(){
        $('#removegroupModal .modal-body h5 kbd').text(getCheckArray());
    })
    
    $('#commitremove').on('click',function(){
        var url = 'group/';
        var data = {}
        data['id']=JSON.stringify(checklist);
        function rmgps(){
            $(".rmgps").removeClass('hidden');
            setTimeout(function(){
               $(".rmgps").addClass('hidden');
               },5000)
        }
        function rmgpf(){
            $(".rmgpf").removeClass('hidden');
            setTimeout(function(){
               $(".rmgpf").addClass('hidden');
               },5000)
        }
       
        $.ajax(url,{dataType:'json',type:'DELETE',data:data}).done(function(data){
            if(data['status'] != 'success'){ rmgpf();}
            else{
                console.log(data);
                getTableData();
                rmgps();
            }
        }).fail(function(){
            rmgpf();
        })
        $('#removegroupModal button.close').click();
    })
    
    
    //======Show group member ==//
    function showMember(){
        var url ='/group/member/'+$("input:checkbox:checked").parent().siblings().first().text();
        $("#showmembersModalLabel").text('主机组成员：'+$("input:checkbox:checked").parent().siblings().first().next().text());
        $.ajax(url,{dataType:'json'}).done(function(data){
            console.log(data);
            let tb = $("#memberlist tbody");
            showDataTable(tb,data,undefined,undefined,undefined);
        }).fail()
    }
    
    $("#showmember").click(function(){
        showMember();
    })
    
    /*
     $.ajax('group/update',{dataType:'json',data:{'id':id,'groupname':'vlntest3'},type:'POST'}).done(function(data){console.log(data)}).fail()
     $.ajax('host/update/',{dataType:'json',data:{'id':'19',hostname:'xmserver20',ipaddr:'2.2.2.3',htype:'cloud',hposition:'xiamen'},type:'POST'}).done(function(data){console.log(data)}).fail()
     
        
    */
    </script>
  
{% end %}
